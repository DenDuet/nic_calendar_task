# Система разделения доступа для WorkCalendar

## Описание

Добавлена система разделения доступа для разных пользователей по группам. Система позволяет гибко настраивать права доступа к различным функциям приложения.

## Новые модели

### 1. UserGroup (Группа пользователей)
- **name** - название группы
- **description** - описание группы
- **permissions** - связи с правами Django
- **is_active** - активна ли группа
- **created_at** - дата создания

### 2. UserProfile (Профиль пользователя)
- **user** - связь с пользователем Django
- **user_group** - группа пользователя
- **staff_member** - связь с сотрудником
- **can_view_projects** - просмотр проектов
- **can_edit_projects** - редактирование проектов
- **can_delete_projects** - удаление проектов
- **can_view_staff** - просмотр сотрудников
- **can_edit_staff** - редактирование сотрудников
- **can_view_customers** - просмотр заказчиков
- **can_edit_customers** - редактирование заказчиков
- **can_manage_users** - управление пользователями
- **can_view_reports** - просмотр отчетов

### 3. ProjectAccess (Доступ к проектам)
- **user** - пользователь
- **project** - проект
- **can_view** - право просмотра
- **can_edit** - право редактирования
- **can_delete** - право удаления
- **granted_by** - кто предоставил доступ
- **granted_at** - когда предоставлен доступ

## Стандартные группы

### Администраторы
- Полный доступ ко всем функциям
- Управление пользователями
- Все права на проекты, сотрудников, заказчиков

### Менеджеры
- Управление проектами (без удаления)
- Управление сотрудниками
- Управление заказчиками
- Просмотр отчетов

### Сотрудники
- Просмотр проектов и отчетов
- Просмотр сотрудников и заказчиков
- Редактирование своих данных

### Наблюдатели
- Только просмотр проектов, отчетов, сотрудников, заказчиков
- Без прав на редактирование

## Установка и настройка

### 1. Активация виртуального окружения
```bash
# Для Windows
venv\Scripts\activate

# Для Linux/Mac
source venv/bin/activate
```

### 2. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 3. Создание миграций
```bash
python manage.py makemigrations prjcalendar
```

### 4. Применение миграций
```bash
python manage.py migrate
```

### 5. Создание суперпользователя (если нет)
```bash
python manage.py createsuperuser
```

### 6. Инициализация системы прав доступа
```bash
python manage.py setup_permissions --all
```

## Команды управления

### Создание групп
```bash
python manage.py setup_permissions --create-groups
```

### Настройка прав
```bash
python manage.py setup_permissions --setup-permissions
```

### Создание профилей
```bash
python manage.py setup_permissions --create-profiles
```

### Все операции
```bash
python manage.py setup_permissions --all
```

## Использование в коде

### Декораторы для проверки прав

```python
from prjcalendar.decorators import (
    user_permission_required,
    project_access_required,
    staff_permission_required,
    customer_permission_required,
    admin_required,
    reports_access_required
)

@user_permission_required('can_view_projects')
def my_view(request):
    # Пользователь должен иметь право просмотра проектов
    pass

@project_access_required('edit')
def edit_project(request, project_id):
    # Пользователь должен иметь право редактирования проекта
    pass

@admin_required
def admin_view(request):
    # Только администраторы
    pass
```

### Проверка прав в представлениях

```python
from prjcalendar.permissions import get_user_permissions, check_project_access

def my_view(request):
    # Получить все права пользователя
    permissions = get_user_permissions(request.user)
    
    # Проверить доступ к проекту
    can_edit = check_project_access(request.user, project_id, 'edit')
    
    # Получить доступные проекты
    accessible_projects = get_accessible_projects(request.user)
```

## Администрирование

После входа в админ-панель Django (`/admin/`) вы сможете:

1. **Управлять группами пользователей** - создавать, редактировать, удалять группы
2. **Настраивать профили пользователей** - назначать группы, настраивать права
3. **Управлять доступом к проектам** - предоставлять специальные права на конкретные проекты
4. **Управлять всеми моделями** - проекты, сотрудники, заказчики

## Настройка прав для существующих пользователей

1. Войдите в админ-панель
2. Перейдите в раздел "Профили пользователей"
3. Найдите нужного пользователя
4. Назначьте группу или настройте права вручную
5. Сохраните изменения

## Безопасность

- Все представления защищены декораторами проверки прав
- Проверка прав происходит на уровне представлений
- Пользователи без прав перенаправляются на главную страницу с сообщением об ошибке
- Логирование всех попыток доступа к защищенным функциям

## Расширение системы

Для добавления новых прав:

1. Добавьте новое поле в модель `UserProfile`
2. Обновите функции в `permissions.py`
3. Создайте новый декоратор в `decorators.py`
4. Обновите админ-панель
5. Создайте и примените миграции

## Поддержка

При возникновении проблем:

1. Проверьте логи Django
2. Убедитесь, что все миграции применены
3. Проверьте, что пользователь назначен в группу
4. Убедитесь, что права группы настроены правильно



